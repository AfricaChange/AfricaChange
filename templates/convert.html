{% extends "base.html" %}
{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-md">
  <h1 class="text-2xl font-bold text-blue-600 text-center mb-4">üí± Convertisseur</h1>

  <!-- Barre de navigation locale -->
  <div class="flex flex-col sm:flex-row justify-between gap-3 mb-4">
    <a href="{{ url_for('auth.tableau_de_bord') }}" 
       class="bg-gray-700 text-white px-4 py-2 rounded text-center hover:bg-gray-800 transition">
      ‚¨Ö Retour
    </a>
    <a href="{{ url_for('main.accueil') }}" 
       class="bg-blue-600 text-white px-4 py-2 rounded text-center hover:bg-blue-700 transition">
      üè† Accueil
    </a>
  </div>

  <form id="conversionForm" method="POST" action="{{ url_for('convert.convertir') }}" class="space-y-4">
    <!-- token CSRF (pour fallback si pas de meta dans base.html) -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="block text-sm font-medium">Montant</label>
      <input id="montant" name="montant" type="number" step="0.01" required class="w-full p-3 border rounded-lg" placeholder="Ex: 5000">
	  <input
             type="tel"
            inputmode="numeric"
            pattern="[0-9+ ]*"
            ...
      >

    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium">De</label>
        <select id="from_currency" name="from_currency" class="w-full p-2 border rounded">
          <option value="CFA">CFA</option>
          <option value="GNF">GNF</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">Vers</label>
        <select id="to_currency" name="to_currency" class="w-full p-2 border rounded">
          <option value="GNF">GNF</option>
          <option value="CFA">CFA</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <div>
        <label class="block text-sm font-medium">T√©l√©phone envoyeur</label>
        <input id="sender_phone" name="sender_phone" type="tel" required class="w-full p-3 border rounded-lg" placeholder="+22177XXXXXXX">
		<input
             type="tel"
            inputmode="numeric"
            pattern="[0-9+ ]*"
            ...
       >
      </div>
      <div>
        <label class="block text-sm font-medium">T√©l√©phone b√©n√©ficiaire</label>
        <input id="receiver_phone" name="receiver_phone" type="tel" required class="w-full p-3 border rounded-lg" placeholder="+22462XXXXXXX">
		<input
             type="tel"
            inputmode="numeric"
            pattern="[0-9+ ]*"
            ...
       >
      </div>
    </div>

    <div class="bg-gray-50 p-3 rounded text-center">
      <p class="text-sm text-gray-600">Montant converti</p>
      <p id="resultat" class="text-2xl font-bold text-green-600">--</p>
      <p id="taux" class="text-xs text-gray-500 mt-1"></p>
    </div>

    <div class="flex gap-3">
      <button type="submit" class="flex-1 bg-blue-600 text-white p-3 rounded-lg">Valider la conversion</button>
      <button type="button" id="resetBtn" class="bg-gray-200 text-gray-700 p-3 rounded-lg">R√©initialiser</button>
    </div>
  </form>

  <!-- SECTION PAIEMENT (s'affiche apr√®s conversion ou peut √™tre utilis√©e pour payer) -->
  <div id="paiementCard" class="mt-6 bg-white border rounded-lg p-4 shadow-sm hidden">
    <h3 class="font-semibold text-lg mb-2">Payer maintenant</h3>
    <p class="text-sm text-gray-600 mb-3">Montant √† payer : <span id="paiement_montant">--</span></p>

    <!-- Exemple: Orange Money -->
    <form id="omForm" action="{{ url_for('paiement.paiement_orange') }}" method="POST" class="space-y-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="montant" id="om_montant" value="">
      <div>
        <label class="block text-sm">Num√©ro Orange Money</label>
        <input id="om_phone" name="telephone" type="tel" required class="w-full p-2 border rounded" placeholder="+22177XXXXXXX">
      </div>
      <button type="submit" class="w-full bg-orange-500 text-white p-2 rounded">üì≤ Payer avec Orange Money</button>
    </form>

    <!-- Wave -->
    <form id="waveForm" action="{{ url_for('paiement.paiement_wave') }}" method="POST" class="space-y-3 mt-3 hidden">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="montant" id="wave_montant" value="">
      <div>
        <label class="block text-sm">Num√©ro Wave</label>
        <input id="wave_phone" name="telephone" type="tel" class="w-full p-2 border rounded" placeholder="+22177XXXXXXX">
      </div>
      <button type="submit" class="w-full bg-blue-700 text-white p-2 rounded">üåä Payer avec Wave</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const montantEl = document.getElementById('montant');
  const fromSelect = document.getElementById('from_currency');
  const toSelect = document.getElementById('to_currency');
  const resultat = document.getElementById('resultat');
  const tauxEl = document.getElementById('taux');

  const paiementCard = document.getElementById('paiementCard');
  const omForm = document.getElementById('omForm');
  const waveForm = document.getElementById('waveForm');
  const omMontant = document.getElementById('om_montant');
  const waveMontant = document.getElementById('wave_montant');
  const omPhone = document.getElementById('om_phone');
  const wavePhone = document.getElementById('wave_phone');

  // Copie envoyeur -> paiement
  const senderPhone = document.getElementById('sender_phone');
  senderPhone.addEventListener('input', () => {
    if (omPhone) omPhone.value = senderPhone.value;
    if (wavePhone) wavePhone.value = senderPhone.value;
  });

  // Reset
  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('conversionForm').reset();
    resultat.textContent = '--';
    tauxEl.textContent = '';
    paiementCard.classList.add('hidden');
  });

  // R√©cup√®re le token CSRF : cherche une meta dans base.html, sinon fallback sur input hidden du formulaire
  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.getAttribute('content')) return meta.getAttribute('content');
    const hidden = document.querySelector('input[name="csrf_token"]');
    if (hidden) return hidden.value;
    return null;
  }

  const csrfToken = getCsrfToken();

  // Fonction qui appelle l'API interne /convert/api/convertir
  async function compute() {
    const m = parseFloat(montantEl.value);
    if (!m || m <= 0) {
      resultat.textContent = '--';
      tauxEl.textContent = '';
      paiementCard.classList.add('hidden');
      return;
    }

    try {
      const headers = {'Content-Type': 'application/json'};
      if (csrfToken) headers['X-CSRFToken'] = csrfToken;

      const res = await fetch('/convert/api/convertir', {
        method: 'POST',
        headers,
        body: JSON.stringify({ montant: m, from_currency: fromSelect.value, to_currency: toSelect.value })
      });

      const data = await res.json();
      if (data.error) {
        resultat.textContent = 'Erreur';
        tauxEl.textContent = data.error;
        paiementCard.classList.add('hidden');
        return;
      }

      // Remplissage UI
      resultat.textContent = `${data.montant_converti} ${toSelect.value}`;
      tauxEl.textContent = `Taux: 1 ${fromSelect.value} = ${data.taux} ${toSelect.value}`;

      // Affiche la carte paiement avec montant pr√©rempli
      paiementCard.classList.remove('hidden');
      omMontant.value = data.montant_converti;
      waveMontant.value = data.montant_converti;
      document.getElementById('paiement_montant').textContent = `${data.montant_converti} ${toSelect.value}`;

      // Affiche/masque les moyens selon devise cible
      if (toSelect.value === 'GNF') {
        // par exemple : afficher OM (Guin√©e) et cacher Wave
        omForm.classList.remove('hidden');
        waveForm.classList.add('hidden');
      } else {
        // vers CFA -> afficher Wave, masquer OM
        waveForm.classList.remove('hidden');
        omForm.classList.add('hidden');
      }

    } catch (err) {
      resultat.textContent = 'Erreur r√©seau';
      tauxEl.textContent = '';
      paiementCard.classList.add('hidden');
      console.error(err);
    }
  }

  montantEl.addEventListener('input', compute);
  fromSelect.addEventListener('change', compute);
  toSelect.addEventListener('change', compute);
});
</script>
{% endblock %}
