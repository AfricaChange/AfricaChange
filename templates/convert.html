{% extends "base.html" %}
{% block back_button %}
<a href="..." class="inline-flex items-center text-sm text-gray-600 hover:text-blue-700 mb-4">
  ‚Üê Retour
</a>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mt-10">
  <h2 class="text-2xl font-bold text-blue-600 mb-4 text-center">üí± Convertisseur AfricaChange</h2>

  <form id="form-conversion" method="POST" action="{{ url_for('convert.convertir') }}" class="space-y-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="block text-sm font-medium text-gray-700">Montant √† convertir :</label>
      <input type="number" step="0.01" id="montant" name="montant"
             class="w-full p-2 border rounded focus:ring focus:ring-blue-300"
             placeholder="Ex: 5000" required>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">De :</label>
        <select id="from_currency" name="from_currency" class="w-full p-2 border rounded">
          <option value="CFA">CFA</option>
          <option value="GNF">GNF</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Vers :</label>
        <select id="to_currency" name="to_currency" class="w-full p-2 border rounded">
          <option value="GNF">GNF</option>
          <option value="CFA">CFA</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">T√©l√©phone envoyeur :</label>
        <input type="tel" id="sender_phone" name="sender_phone"
               class="w-full p-2 border rounded" placeholder="Ex: +221771234567" required>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">T√©l√©phone r√©cepteur :</label>
        <input type="tel" id="receiver_phone" name="receiver_phone"
               class="w-full p-2 border rounded" placeholder="Ex: +224621456789" required>
      </div>
    </div>

    <div class="mt-4 bg-gray-50 p-3 rounded text-center shadow-inner">
      <p class="text-gray-600">Montant converti :</p>
      <p id="resultat" class="text-2xl font-semibold text-green-600 transition-all duration-300">--</p>
      <p id="taux" class="text-sm text-gray-500"></p>
    </div>

    <div class="text-center mt-6">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
        Valider la conversion
      </button>
    </div>
  </form>

  <!-- Paiement Orange Money -->
  <div class="mt-6 bg-orange-50 p-4 rounded-lg shadow">
    <h3 class="font-bold text-orange-600 mb-2">Payer avec Orange Money</h3>

    <form id="form-om" action="{{ url_for('paiement.paiement_orange') }}" method="POST" class="space-y-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="montant" id="montant_om" value="">
        <div>
            <label class="block text-gray-700">Num√©ro Orange Money</label>
            <input type="text" name="telephone" id="om_phone" class="w-full border p-2 rounded" placeholder="+22177xxxxxxx" required>
        </div>

        <button type="submit"
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded w-full">
            üì≤ Payer avec Orange Money
        </button>
    </form>
  </div>

  <!-- Paiement Wave -->
  <div class="mt-4 bg-cyan-50 p-4 rounded-lg shadow">
    <h3 class="font-bold text-cyan-700 mb-2">Payer avec Wave</h3>

    <form id="form-wave" action="{{ url_for('paiement.paiement_wave') }}" method="POST" class="space-y-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="montant" id="montant_wave" value="">
        <div>
            <label class="block text-gray-700">Num√©ro Wave</label>
            <input type="text" name="telephone" id="wave_phone" class="w-full border p-2 rounded" placeholder="+22177xxxxxxx" required>
        </div>

        <button type="submit"
                class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded w-full">
            üåä Payer avec Wave
        </button>
    </form>
  </div>

  <div class="flex justify-between mt-6">
    <a href="{{ url_for('auth.tableau_de_bord') }}" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 transition">‚¨Ö Retour</a>
    <a href="{{ url_for('main.accueil') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">üè† Accueil</a>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const montantInput = document.getElementById("montant");
  const fromSelect = document.getElementById("from_currency");
  const toSelect = document.getElementById("to_currency");
  const resultatEl = document.getElementById("resultat");
  const tauxEl = document.getElementById("taux");

  const senderPhone = document.getElementById("sender_phone");
  const receiverPhone = document.getElementById("receiver_phone");

  const montantOm = document.getElementById("montant_om");
  const omPhone = document.getElementById("om_phone");

  const montantWave = document.getElementById("montant_wave");
  const wavePhone = document.getElementById("wave_phone");

  // Appelle l'API AJAX pour obtenir la conversion
  async function convertirEtSync() {
    const montant = parseFloat(montantInput.value);
    if (!montant || montant <= 0) {
      resultatEl.textContent = "--";
      tauxEl.textContent = "";
      montantOm.value = "";
      montantWave.value = "";
      return;
    }

    resultatEl.textContent = "Calcul en cours...";
    tauxEl.textContent = "";

    try {
      const resp = await fetch("/convert/api/convertir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          montant: montant,
          from_currency: fromSelect.value,
          to_currency: toSelect.value
        })
      });

      const data = await resp.json();
      if (data.error) {
        resultatEl.textContent = "Erreur";
        tauxEl.textContent = data.error;
        montantOm.value = "";
        montantWave.value = "";
      } else {
        resultatEl.textContent = `${data.montant_converti} ${toSelect.value}`;
        tauxEl.textContent = `Taux : 1 ${fromSelect.value} = ${data.taux} ${toSelect.value}`;

        // On envoie ici le montant converti aux prestataires
        montantOm.value = data.montant_converti;
        montantWave.value = data.montant_converti;

        resultatEl.classList.add("scale-110");
        setTimeout(() => resultatEl.classList.remove("scale-110"), 200);
      }
    } catch (err) {
      resultatEl.textContent = "Erreur r√©seau";
      montantOm.value = "";
      montantWave.value = "";
    }
  }

  // Sync t√©l√©phone envoyeur ‚Üí OM / Wave si utilisateur n'a pas modifi√© les champs
  function syncPhones() {
    if (!omPhone.dataset.touched) { omPhone.value = senderPhone.value; }
    if (!wavePhone.dataset.touched) { wavePhone.value = senderPhone.value; }
  }

  // Si l'utilisateur modifie manuellement omPhone / wavePhone on ne l'√©crase plus
  omPhone.addEventListener("input", () => { omPhone.dataset.touched = "1"; });
  wavePhone.addEventListener("input", () => { wavePhone.dataset.touched = "1"; });

  // √âv√©nements
  montantInput.addEventListener("input", convertirEtSync);
  fromSelect.addEventListener("change", convertirEtSync);
  toSelect.addEventListener("change", convertirEtSync);
  senderPhone.addEventListener("input", syncPhones);

  convertirEtSync();
  syncPhones();

  // Confirm avant soumission OM
  document.getElementById("form-om").addEventListener("submit", (e) => {
    if (!montantOm.value || montantOm.value === "") {
      e.preventDefault();
      alert("Le montant converti n'est pas d√©fini ‚Äî v√©rifie le montant ou s√©lectionne les devises puis r√©essaye.");
      return;
    }
    if (!omPhone.value || omPhone.value.trim() === "") {
      e.preventDefault();
      alert("Veuillez renseigner votre num√©ro Orange Money.");
      omPhone.focus();
      return;
    }
    const ok = confirm(`Vous allez payer ${montantOm.value} (${toSelect.value}) avec Orange Money au num√©ro ${omPhone.value}. Confirmer ?`);
    if (!ok) e.preventDefault();
  });

  // Confirm avant soumission Wave
  document.getElementById("form-wave").addEventListener("submit", (e) => {
    if (!montantWave.value || montantWave.value === "") {
      e.preventDefault();
      alert("Le montant converti n'est pas d√©fini ‚Äî v√©rifie le montant ou s√©lectionne les devises puis r√©essaye.");
      return;
    }
    if (!wavePhone.value || wavePhone.value.trim() === "") {
      e.preventDefault();
      alert("Veuillez renseigner votre num√©ro Wave.");
      wavePhone.focus();
      return;
    }
    const ok = confirm(`Vous allez payer ${montantWave.value} (${toSelect.value}) avec Wave au num√©ro ${wavePhone.value}. Confirmer ?`);
    if (!ok) e.preventDefault();
  });
});
</script>
{% endblock %}
