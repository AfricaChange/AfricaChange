{% extends "base_admin.html" %}

{% block content %}
{% include "admin/components/admin_modals.html" %}

<h1 class="text-2xl font-bold mb-6">ðŸ’³ Transactions LIVE</h1>

<!-- ===================== -->
<!-- ðŸ”Ž FILTRES -->
<!-- ===================== -->
<form method="get" class="flex flex-wrap gap-3 mb-6 text-sm">

  <select name="status" class="border rounded px-2 py-1">
    <option value="">Statut</option>
    <option value="en_attente" {% if request.args.get('status') == 'en_attente' %}selected{% endif %}>En attente</option>
    <option value="valide" {% if request.args.get('status') == 'valide' %}selected{% endif %}>ValidÃ©e</option>
    <option value="bloque" {% if request.args.get('status') == 'bloque' %}selected{% endif %}>BloquÃ©e</option>
    <option value="echoue" {% if request.args.get('status') == 'echoue' %}selected{% endif %}>Ã‰chouÃ©e</option>
  </select>

  <select name="provider" class="border rounded px-2 py-1">
    <option value="">Fournisseur</option>
    <option value="Orange Money">Orange Money</option>
    <option value="Wave">Wave</option>
    <option value="Simulation">Simulation</option>
    <option value="admin">Admin</option>
  </select>

  <input name="q"
         value="{{ request.args.get('q','') }}"
         placeholder="RÃ©fÃ©rence"
         class="border rounded px-2 py-1">

  <!-- âš ï¸ submit explicite -->
  <button type="submit"
          class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">
    Filtrer
  </button>
</form>

<!-- ===================== -->
<!-- ðŸ“‹ TABLE TRANSACTIONS -->
<!-- ===================== -->
<table class="w-full bg-white shadow rounded text-sm">
  <thead class="bg-gray-100">
    <tr>
      <th class="p-2 text-left">Date</th>
      <th class="p-2 text-left">RÃ©fÃ©rence</th>
      <th class="p-2 text-right">Montant</th>
      <th class="p-2 text-left">Statut</th>
      <th class="p-2 text-left">Provider</th>
      <th class="p-2 text-center">Actions</th>
    </tr>
  </thead>

  <tbody>
    {% for tx in transactions %}
    <tr class="border-t hover:bg-gray-50">

      <td class="p-2 text-xs">
        {{ tx.date_transaction.strftime('%d/%m %H:%M') if tx.date_transaction else 'â€”' }}
      </td>

      <td class="p-2 font-mono">
        {{ tx.reference }}
      </td>

      <td class="p-2 text-right font-semibold">
        {{ tx.montant }} XOF
      </td>

      <td class="p-2">
        {{ tx.statut }}
      </td>

      <td class="p-2">
        {{ tx.fournisseur }}
      </td>

      <!-- ===================== -->
      <!-- âš™ï¸ ACTIONS ADMIN -->
      <!-- ===================== -->
      <td class="p-2 text-center space-x-2">

        {% if tx.statut == "en_attente" %}
          <button type="button"
                  onclick="openAdminModal('validate','{{ tx.reference }}')"
                  class="text-green-600 hover:text-green-800"
                  title="Valider">
            âœ”
          </button>

          <button type="button"
                  onclick="openAdminModal('block','{{ tx.reference }}')"
                  class="text-red-600 hover:text-red-800"
                  title="Bloquer">
            â›”
          </button>

        {% elif tx.statut == "valide" %}
          <button type="button"
                  onclick="openAdminModal('refund','{{ tx.reference }}')"
                  class="text-yellow-600 hover:text-yellow-800"
                  title="Rembourser">
            ðŸ’¸
          </button>

        {% else %}
          <span class="text-gray-400 text-xs">â€”</span>
        {% endif %}

      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if transactions|length == 0 %}
  <div class="text-center text-gray-500 mt-6">
    Aucune transaction trouvÃ©e.
  </div>
{% endif %}

{% endblock %}
